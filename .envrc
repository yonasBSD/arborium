#!/usr/bin/env bash

# Repo-local toolchain setup for wasm32 C compilation on macOS.
# Apple clang does not support --target=wasm32-unknown-unknown.

llvm_prefix=""

if command -v brew >/dev/null 2>&1; then
  llvm_prefix="$(brew --prefix llvm 2>/dev/null || true)"
fi

if [ -z "$llvm_prefix" ]; then
  if [ -d /opt/homebrew/opt/llvm ]; then
    llvm_prefix=/opt/homebrew/opt/llvm
  elif [ -d /usr/local/opt/llvm ]; then
    llvm_prefix=/usr/local/opt/llvm
  fi
fi

if [ -n "$llvm_prefix" ] && [ -x "$llvm_prefix/bin/clang" ]; then
  case ":$PATH:" in
    *":$llvm_prefix/bin:"*) ;;
    *) export PATH="$llvm_prefix/bin:$PATH" ;;
  esac

  export CC_wasm32_unknown_unknown="$llvm_prefix/bin/clang"
  export CXX_wasm32_unknown_unknown="$llvm_prefix/bin/clang++"

  if [ -x "$llvm_prefix/bin/llvm-ar" ]; then
    export AR_wasm32_unknown_unknown="$llvm_prefix/bin/llvm-ar"
  fi
fi
