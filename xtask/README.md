# xtask

Development tooling for arborium. Run commands with `cargo xtask <command>`.

## Commands

### `cargo xtask doctor`

Check that required external tools are installed (tree-sitter CLI, cargo-component, jco, etc.).

### `cargo xtask lint [--strict]`

Validate all grammar configurations in `crates/*/arborium.kdl`.

- Checks required fields, tier ranges, sample files exist
- `--strict`: Treat missing generated files (parser.c) as errors

### `cargo xtask gen [name] [--dry-run]`

Regenerate crate files from `arborium.kdl` configurations.

**Generated files:**
- `Cargo.toml` - package metadata, dependencies
- `build.rs` - C compilation setup
- `src/lib.rs` - language function exports
- `grammar/src/` - parser sources (via tree-sitter generate)

```bash
cargo xtask gen              # Regenerate all grammars
cargo xtask gen rust         # Regenerate only rust
cargo xtask gen --dry-run    # Preview changes without writing
```

### `cargo xtask serve [-a <addr>] [-p <port>] [--dev]`

Build and serve the WASM demo locally.

```bash
cargo xtask serve            # Build and serve on auto-selected port
cargo xtask serve --dev      # Fast dev build (skip wasm-opt)
cargo xtask serve -p 3000    # Serve on specific port
```

### `cargo xtask plugins <subcommand>`

Build WASM component plugins for browser usage.

#### `cargo xtask plugins build [grammars...] [-o <dir>] [--no-transpile] [--profile]`

Build grammar plugins as WASM components.

```bash
cargo xtask plugins build                    # Build all plugins
cargo xtask plugins build rust javascript    # Build specific plugins
cargo xtask plugins build --profile          # Record build times to plugin-timings.json
cargo xtask plugins build --no-transpile     # Skip jco transpile step
```

#### `cargo xtask plugins clean [-o <dir>]`

Clean plugin build artifacts from the output directory.

#### `cargo xtask plugins groups [-n <count>] [--timings <path>]`

Show how plugins would be grouped for parallel CI builds based on recorded timings.

```bash
cargo xtask plugins groups           # Show 2 groups (default)
cargo xtask plugins groups -n 4      # Show 4 groups
```

### `cargo xtask ci <subcommand>`

Manage CI workflow generation.

#### `cargo xtask ci generate [--check]`

Generate `.github/workflows/ci.yml` from Rust code in `xtask/src/ci.rs`.

```bash
cargo xtask ci generate          # Write ci.yml
cargo xtask ci generate --check  # Verify ci.yml is up to date (for CI)
```

If `plugin-timings.json` exists, generates parallel `build-plugins-N` jobs
balanced by measured build times.

## Plugin Build Parallelization

Split WASM plugin builds across CI runners based on measured times:

```bash
# 1. Profile build times locally
cargo xtask plugins build --profile

# 2. Preview grouping (optional)
cargo xtask plugins groups -n 2

# 3. Regenerate CI workflow
cargo xtask ci generate

# 4. Commit plugin-timings.json and ci.yml
```

The grouping uses LPT (Longest Processing Time First) bin-packing to balance
build times across runners.

## Configuration

### arborium.kdl

Each grammar crate has an `arborium.kdl` file as its source of truth:

```kdl
repo "https://github.com/tree-sitter/tree-sitter-rust"
commit "abc123..."
license "MIT"
authors "Someone"

grammar {
    id "rust"
    name "Rust"
    tag "code"
    tier 1
    icon "devicon-plain:rust"
    aliases "rs"

    has_scanner #true
    generate-component #true  // Build as WASM plugin

    sample {
        path "samples/example.rs"
        description "Example code"
    }
}
```

**Key fields:**
- `generate-component #true` - Include in WASM plugin builds
- `has_scanner #true` - Grammar has external scanner (scanner.c)
- `tier` - 1-5, affects default feature inclusion
- `aliases` - File extensions/alternative names

### plugin-timings.json

Generated by `cargo xtask plugins build --profile`. Contains measured build
times used to balance CI parallelization. Commit this file to the repo.

### compression.kdl

Compression settings for WASM optimization:

```kdl
brotli {
    quality 11
}
gzip {
    level 9
}
zstd {
    level 19
}
```
