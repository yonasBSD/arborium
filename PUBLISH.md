# Publishing Guide

## The New Paradigm

**The git tag is the single source of truth for versions.**

- Locally, versions are `0.0.0-dev` - they don't matter
- CI parses the version from the tag (e.g., `v0.3.0` → `0.3.0`)
- CI runs `xtask gen --version 0.3.0` which sets all versions
- Then CI publishes everything

This means:
- No version drift or mismatch issues
- No "forgot to bump version" mistakes
- No chore commits for version bumps
- Clean, simple workflow

## Release Flow

When you push a tag, here's what happens:

```
tag push v0.3.0
       │
       ▼
parse version (v0.3.0 → 0.3.0)
       │
       ▼
xtask gen --version 0.3.0
       │
       ├─────────────────┬─────────────────┐
       │                 │                 │
       ▼                 ▼                 ▼
  publish            build WASM       build WASM
  crates.io          plugins (rust)   plugins (js, html)
       │                 │                 │
       │                 └────────┬────────┘
       │                          │
       │                          ▼
       │                     publish npm
       │                          │
       └──────────────────────────┘
                    │
                    ▼
                  done
```

**Key insight**: crates.io publish and WASM plugin builds run **in parallel** - neither depends on the other. npm publish waits only for WASM builds.

## Two Outputs, Two Registries

### 1. Native Rust Crates → crates.io

- 98 grammar crates (`arborium-rust`, `arborium-javascript`, etc.)
- Plus core crates (`arborium`, `miette-arborium`, `tree-sitter-*`)
- Regular `cargo publish --workspace`
- **Retry-safe**: cargo warns and skips already-published versions

### 2. WASM Plugins → npm

- Only grammars with `generate-component: true` in arborium.kdl
- Currently: rust, javascript, html
- Built via `cargo-component` for `wasm32-wasip2`
- Transpiled via `jco` for browser compatibility
- Becomes `@arborium/lang-rust`, `@arborium/lang-javascript`, etc.

## Publishing Strategy

### crates.io (easy)

Cargo handles already-published versions gracefully - it warns and continues:
```
warning: crate arborium-rust@0.3.0 already exists on crates.io
```

So we can just retry failed builds and it skips what's done.

### npm (needs xtask)

npm is **not graceful** - it hard-fails with `EPUBLISHCONFLICT`:
```
npm ERR! code EPUBLISHCONFLICT
npm ERR! Cannot publish over existing version
```

**This is why we need `xtask publish`** instead of bash scripts:
- Must check if version exists before attempting publish
- Must distinguish `EPUBLISHCONFLICT` (skip, continue) from real errors (fail)
- Must handle retries properly without re-publishing what succeeded

The bash approach `npm publish || echo "failed"` **swallows real errors** - unacceptable.

## What's in Git vs Generated

### Committed to Git (source of truth)

```
crates/arborium-{lang}/
├── arborium.kdl          ← SOURCE OF TRUTH (grammar config, license, metadata)
├── grammar/
│   ├── grammar.js        ← tree-sitter grammar definition
│   └── scanner.c         ← custom scanner (if any)
├── queries/
│   └── highlights.scm    ← highlight queries
└── samples/              ← test samples
```

### Generated (gitignored)

```
crates/arborium-{lang}/
├── Cargo.toml            ← GENERATED by xtask gen
├── build.rs              ← GENERATED by xtask gen
├── src/lib.rs            ← GENERATED by xtask gen
└── grammar/
    └── src/              ← GENERATED by xtask gen (tree-sitter generate)
        ├── parser.c
        ├── grammar.json
        └── ...
```

### Non-generated crates (hand-written, committed)

These crates don't have `arborium.kdl` and are fully hand-written:
- `arborium` (main crate)
- `arborium-test-harness`
- `arborium-sysroot`
- `arborium-host`
- `arborium-wire`
- `arborium-plugin-runtime`
- `miette-arborium`

## What `xtask gen --version X.Y.Z` Does

1. **Updates root `Cargo.toml`:**
   - `[workspace.package] version = "X.Y.Z"`
   - All `[workspace.dependencies]` version fields

2. **Generates grammar crate files:**
   - `Cargo.toml` with version `X.Y.Z` and license from `arborium.kdl`
   - `build.rs` with correct C compilation setup
   - `src/lib.rs` with language exports
   - `grammar/src/*` via tree-sitter generate

When called without `--version`, uses `0.0.0-dev` (fine for local dev since path deps ignore versions).

## Workflows

### Local Development

```bash
# Edit arborium.kdl, grammar.js, queries, etc.

# Regenerate (uses 0.0.0-dev version, doesn't matter locally)
cargo xtask gen

# Build and test
cargo build
cargo test
```

### Release

```bash
# That's it. Just tag and push.
git tag v0.3.0
git push origin v0.3.0

# CI does the rest:
# 1. Parse version from tag
# 2. xtask gen --version 0.3.0
# 3. Parallel: publish crates.io + build WASM plugins
# 4. After WASM: publish npm
```

## Artifacts Published

| Registry | Package | Count |
|----------|---------|-------|
| crates.io | `arborium` | 1 |
| crates.io | `arborium-{lang}` | 98 |
| crates.io | `arborium-test-harness` | 1 |
| crates.io | `arborium-sysroot` | 1 |
| crates.io | `tree-sitter-patched-arborium` | 1 |
| crates.io | `tree-sitter-highlight-patched-arborium` | 1 |
| crates.io | `miette-arborium` | 1 |
| npmjs.com | `@arborium/arborium` | 1 |
| npmjs.com | `@arborium/lang-{lang}` | 3 (rust, js, html) |

## TODO

- [ ] Implement `xtask publish` command with:
  - [ ] crates.io publishing (relies on cargo's skip-existing behavior)
  - [ ] npm publishing with proper EPUBLISHCONFLICT handling
- [ ] Unify release.yml and npm-publish.yml into single workflow
