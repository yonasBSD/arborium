# GENERATED BY: cargo xtask ci generate
# DO NOT EDIT - edit xtask/src/ci.rs instead
---
name: CI
"on": 
  push: 
    branches: 
      - main

  pull_request: 
    branches: 
      - main

  merge_group: 
env: 
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: "0"
  CARGO_PROFILE_TEST_DEBUG: "0"

jobs: 
  generate: 
    name: ðŸŒ± Generate Grammars
    runs-on: depot-ubuntu-24.04-32
    container: "ghcr.io/bearcove/arborium-plugin-builder:latest"
    steps: 
      - 
        name: Checkout
        uses: actions/checkout@v4
      - 
        name: Restore grammar generation cache
        uses: actions/cache@v4
        with: 
          path: .cache/arborium
          key: "grammar-cache-v2-${{ hashFiles('crates/*/grammar/grammar.js', 'crates/*/grammar/package.json', 'crates/*/common/**') }}"
          restore-keys: grammar-cache-v2-

      - 
        name: Generate grammar sources
        run: arborium-xtask gen
      - 
        name: Create grammar sources tarball
        run: "# Collect all generated grammar/src directories\nfind crates -type d -name 'src' -path '*/grammar/src' > grammar_dirs.txt\ntar -cvf grammar-sources.tar -T grammar_dirs.txt"
      - 
        name: Upload grammar sources
        uses: actions/upload-artifact@v4
        with: 
          name: grammar-sources
          path: grammar-sources.tar
          retention-days: "1"


  test-linux: 
    name: ðŸ§ Test (Linux)
    runs-on: depot-ubuntu-24.04-32
    container: "ghcr.io/bearcove/arborium-plugin-builder:latest"
    needs: 
      - generate

    steps: 
      - 
        name: Checkout
        uses: actions/checkout@v4
      - 
        name: Download grammar sources
        uses: actions/download-artifact@v4
        with: 
          name: grammar-sources

      - 
        name: Extract grammar sources
        run: tar -xvf grammar-sources.tar
      - 
        name: Build
        run: cargo build --locked --verbose
      - 
        name: Run tests
        run: cargo nextest run --locked --verbose
      - 
        name: Build with all features
        run: cargo build --locked --all-features --verbose

  test-macos: 
    name: ðŸŽ Test (macOS)
    runs-on: depot-macos-latest
    needs: 
      - generate

    steps: 
      - 
        name: Checkout
        uses: actions/checkout@v4
      - 
        name: Download grammar sources
        uses: actions/download-artifact@v4
        with: 
          name: grammar-sources

      - 
        name: Extract grammar sources
        run: tar -xvf grammar-sources.tar
      - 
        name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      - 
        name: Rust cache
        uses: Swatinem/rust-cache@v2
      - 
        name: Install nextest
        uses: taiki-e/install-action@v2
        with: 
          tool: cargo-nextest

      - 
        name: Build
        run: cargo build --locked --verbose
      - 
        name: Run tests
        run: cargo nextest run --locked --verbose

  wasm: 
    name: ðŸŒ WASM Compatibility
    runs-on: depot-ubuntu-24.04-32
    container: "ghcr.io/bearcove/arborium-plugin-builder:latest"
    needs: 
      - generate

    steps: 
      - 
        name: Checkout
        uses: actions/checkout@v4
      - 
        name: Download grammar sources
        uses: actions/download-artifact@v4
        with: 
          name: grammar-sources

      - 
        name: Extract grammar sources
        run: tar -xvf grammar-sources.tar
      - 
        name: Build arborium for WASM
        run: cargo build --locked -p arborium --target wasm32-unknown-unknown
      - 
        name: Check for env imports in WASM
        run: "# Find all .wasm files and check for env imports\nfound_env_imports=false\nfor wasm_file in $(find target/wasm32-unknown-unknown -name \"*.wasm\" -type f); do\n  if wasm-objdump -j Import -x \"$wasm_file\" 2>/dev/null | grep -q '<- env\\.'; then\n    echo \"ERROR: Found env imports in $wasm_file:\"\n    wasm-objdump -j Import -x \"$wasm_file\" | grep '<- env\\.'\n    found_env_imports=true\n  fi\ndone\nif [ \"$found_env_imports\" = true ]; then\n  echo \"WASM modules should not have env imports - these won't work in the browser\"\n  exit 1\nfi\necho \"No env imports found - WASM modules are browser-compatible\""

  clippy: 
    name: ðŸ“Ž Clippy
    runs-on: depot-ubuntu-24.04-32
    container: "ghcr.io/bearcove/arborium-plugin-builder:latest"
    needs: 
      - generate

    steps: 
      - 
        name: Checkout
        uses: actions/checkout@v4
      - 
        name: Download grammar sources
        uses: actions/download-artifact@v4
        with: 
          name: grammar-sources

      - 
        name: Extract grammar sources
        run: tar -xvf grammar-sources.tar
      - 
        name: Run Clippy
        run: cargo clippy --locked --all-targets -- -D warnings

  fmt: 
    name: ðŸ“ Format
    runs-on: depot-ubuntu-24.04-4
    container: "ghcr.io/bearcove/arborium-plugin-builder:latest"
    steps: 
      - 
        name: Checkout
        uses: actions/checkout@v4
      - 
        name: Check formatting
        run: cargo fmt --all -- --check
      - 
        name: Check CI workflow is up to date
        run: arborium-xtask ci generate --check

  docs: 
    name: ðŸ“š Documentation
    runs-on: depot-ubuntu-24.04-32
    container: "ghcr.io/bearcove/arborium-plugin-builder:latest"
    needs: 
      - generate

    steps: 
      - 
        name: Checkout
        uses: actions/checkout@v4
      - 
        name: Download grammar sources
        uses: actions/download-artifact@v4
        with: 
          name: grammar-sources

      - 
        name: Extract grammar sources
        run: tar -xvf grammar-sources.tar
      - 
        name: Build docs
        run: cargo doc --locked --no-deps
        env: 
          RUSTDOCFLAGS: "-D warnings"


  build-plugins-0: 
    name: "ðŸ”Œ Plugins (1 of 2): rust"
    runs-on: depot-ubuntu-24.04-32
    container: "ghcr.io/bearcove/arborium-plugin-builder:latest"
    needs: 
      - generate

    steps: 
      - 
        name: Checkout
        uses: actions/checkout@v4
      - 
        name: Download grammar sources
        uses: actions/download-artifact@v4
        with: 
          name: grammar-sources

      - 
        name: Extract grammar sources
        run: tar -xvf grammar-sources.tar
      - 
        name: Build rust
        run: arborium-xtask plugins build rust
      - 
        name: Upload plugins artifact
        uses: actions/upload-artifact@v4
        with: 
          name: plugins-group-0
          path: dist/plugins
          retention-days: "7"


  build-plugins-1: 
    name: "ðŸ”Œ Plugins (2 of 2): javascript, html"
    runs-on: depot-ubuntu-24.04-32
    container: "ghcr.io/bearcove/arborium-plugin-builder:latest"
    needs: 
      - generate

    steps: 
      - 
        name: Checkout
        uses: actions/checkout@v4
      - 
        name: Download grammar sources
        uses: actions/download-artifact@v4
        with: 
          name: grammar-sources

      - 
        name: Extract grammar sources
        run: tar -xvf grammar-sources.tar
      - 
        name: Build javascript, html
        run: arborium-xtask plugins build javascript html
      - 
        name: Upload plugins artifact
        uses: actions/upload-artifact@v4
        with: 
          name: plugins-group-1
          path: dist/plugins
          retention-days: "7"


  collect-plugins: 
    name: ðŸ“¦ Collect Plugins
    runs-on: depot-ubuntu-24.04-4
    needs: 
      - build-plugins-0
      - build-plugins-1

    steps: 
      - 
        name: Checkout
        uses: actions/checkout@v4
      - 
        name: Create dist directory
        run: mkdir -p dist/plugins
      - 
        name: Download plugins group 0
        uses: actions/download-artifact@v4
        with: 
          name: plugins-group-0
          path: dist/plugins

      - 
        name: Download plugins group 1
        uses: actions/download-artifact@v4
        with: 
          name: plugins-group-1
          path: dist/plugins

      - 
        name: List collected plugins
        run: find dist/plugins -type f | sort


