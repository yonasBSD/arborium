/// Arborium host interface - state machine highlighter for browser.
///
/// The host is a WASM component that manages highlighting sessions using
/// a state machine pattern. This allows JS to handle async grammar loading
/// while all WASM execution remains synchronous.
///
/// Architecture:
/// 1. JS creates a session with create-session(language, source)
/// 2. JS calls step() which returns Done(html) or NeedGrammar(language)
/// 3. If NeedGrammar, JS loads the grammar plugin (async) then calls provide-grammar()
/// 4. Repeat step 2-3 until Done
///
/// This pattern keeps WASM synchronous while JS handles async I/O.

package arborium:host@0.2.0;

/// Core types used by the host.
interface types {
    /// A span of highlighted text.
    record span {
        start: u32,
        end: u32,
        capture: string,
    }

    /// An injection point where another language should be parsed.
    record injection {
        start: u32,
        end: u32,
        language: string,
        include-children: bool,
    }

    /// Result of parsing text.
    record parse-result {
        spans: list<span>,
        injections: list<injection>,
    }

    /// Parse error.
    record parse-error {
        message: string,
    }

    /// A handle to a grammar plugin (opaque, managed by JS).
    type grammar-handle = u32;

    /// Result of calling step() on a session.
    variant step-result {
        /// Highlighting complete, here's the HTML.
        done(string),
        /// Need a grammar before continuing. JS should load it and call provide-grammar().
        need-grammar(string),
    }
}

/// Interface for calling into grammar plugins.
/// JS implements this by dispatching to the appropriate loaded plugin.
interface grammar-plugin {
    use types.{grammar-handle, parse-result, parse-error};

    /// Parse text using a grammar plugin.
    /// The grammar-handle identifies which plugin to use.
    parse: func(handle: grammar-handle, text: string) -> result<parse-result, parse-error>;
}

/// The main host API exported to JS.
interface host {
    use types.{grammar-handle, step-result};

    /// A highlighting session handle.
    type session = u32;

    /// Create a new highlighting session.
    /// Returns a session handle that can be used with step() and provide-grammar().
    create-session: func(language: string, source: string) -> session;

    /// Free a session and its resources.
    free-session: func(session: session);

    /// Advance the highlighter state machine.
    /// Returns Done(html) when complete, or NeedGrammar(language) when a grammar is needed.
    /// If NeedGrammar is returned, call provide-grammar() then step() again.
    step: func(session: session) -> step-result;

    /// Provide a grammar that was requested by a previous step() call.
    /// Call this after loading a grammar plugin, then call step() to continue.
    provide-grammar: func(session: session, language: string, handle: grammar-handle);

    /// Set the maximum injection depth for a session (default: 3).
    set-max-depth: func(session: session, depth: u32);
}

/// The world that the host component implements.
world arborium-host {
    /// Import grammar plugin interface (implemented by JS).
    import grammar-plugin;

    /// Export the host API.
    export host;
}
